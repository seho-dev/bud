# 核心概念

本文档定义了 Bud 插件系统的核心概念和术语，为理解系统架构提供参考。

## 三层架构总览

Bud 系统采用经典的三层架构设计，各层职责明确、边界清晰：

```
┌─────────────────────────────────────────────────────────────┐
│                    宿主应用层 (Host Application)              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   C++ 应用   │  │  Python 应用 │  │   Node.js 应用      │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │             │
│         └────────────────┼─────────────────────┘             │
│                          │                                   │
│              ┌───────────▼───────────┐                       │
│              │  权限 UI / 用户交互    │                       │
│              │  生命周期管理         │                       │
│              │  宿主函数注册         │                       │
│              └───────────┬───────────┘                       │
└──────────────────────────┼───────────────────────────────────┘
                           │
┌──────────────────────────▼───────────────────────────────────┐
│                    运行时层 (Runtime Core)                    │
│  ┌─────────────────────────────────────────────────────┐     │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐      │     │
│  │  │ 清单解析器  │ │ 权限管理器  │ │ 生命周期   │      │     │
│  │  │           │ │            │ │ 管理器     │      │     │
│  │  └────────────┘ └────────────┘ └────────────┘      │     │
│  │                                                     │     │
│  │  ┌────────────────────────────────────────────┐    │     │
│  │  │              Provider 接口层               │    │     │
│  │  └────────────────────────────────────────────┘    │     │
└───────────────────────────────────────────────────────────┘
                           │
┌──────────────────────────▼───────────────────────────────────┐
│                    插件层 (Plugins)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  WASM 插件   │  │  JS 插件    │  │   其他格式插件       │  │
│  │  (.wasm)    │  │  (.js)     │  │   (未来支持)        │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │             │
│         └────────────────┼─────────────────────┘             │
│                          │                                   │
│              ┌───────────▼───────────┐                       │
│              │  bud.json 清单文件    │                       │
│              │  权限声明             │                       │
│              │  事件处理逻辑         │                       │
│              └───────────────────────┘                       │
└─────────────────────────────────────────────────────────────┘
```

### 1. 宿主应用层 (Host Application)

宿主应用是用户直接交互的应用程序，它可以是任意语言实现。宿主应用层的主要职责包括：

**用户界面交互**
- 向用户展示插件安装界面
- 显示权限质询对话框
- 提供插件管理界面（启用/禁用/卸载）
- 展示插件运行状态和错误信息

**生命周期管理**
- 响应用户操作触发插件加载/卸载
- 处理插件间的依赖关系
- 管理插件的更新和版本兼容性
- 协调多个插件的执行顺序

**宿主函数注册**
- 定义可供插件调用的 API 接口
- 实现宿主函数的具体逻辑
- 注册函数到 Runtime 的函数表
- 处理插件的跨语言调用请求

**事件转发**
- 接收系统事件（用户输入、网络状态变化等）
- 将事件分发给相关插件
- 聚合插件的响应结果

### 2. 运行时层 (Runtime Core)

运行时层是 Bud 系统的核心引擎，使用 Rust 实现，提供高性能的插件管理能力。

**清单解析器 (Manifest Parser)**
- 解析插件包的 bud.json 文件
- 验证清单格式的正确性
- 提取插件的元数据信息
- 解析权限声明并构建权限树

**权限管理器 (Permission Manager)**
- 维护权限白名单和黑名单
- 运行时权限检查和拦截
- 权限粒度控制（API 级别、参数级别）
- 权限授予状态的持久化存储

**生命周期管理器 (Lifecycle Manager)**
- 管理插件的加载、初始化、运行、卸载状态
- 处理插件间的依赖注入
- 协调插件的资源分配和回收
- 处理插件异常和恢复策略

**Provider 接口层**
- 定义 Provider 的标准接口
- 管理 Provider 实例的生命周期
- 提供插件与 Runtime 之间的桥梁
- 实现跨 Provider 的抽象兼容层

### 3. 插件层 (Plugins)

插件是实际的功能扩展单元，每个插件都是一个独立的发布包。

**插件包结构**
```
my-plugin/
├── bud.json              # 插件清单文件
├── plugin.wasm           # 插件主文件（WASM 格式）
├── README.md             # 插件说明文档
├── config.json           # 可选配置文件
└── resources/            # 可选资源目录
    ├── icons/
    └── locales/
```

**插件类型支持**
- **WASM 插件**: 基于 WebAssembly，提供高性能和强隔离
- **JavaScript 插件**: 基于 Node.js 或 Bun 运行时
- **Native 插件**: C/C++ 扩展（未来计划）

## 核心概念定义

### Plugin (插件)

插件是已编译的扩展模块，通过 Provider 运行时执行。每个插件包含以下组成部分：

**可执行文件**
- WASM 格式：.wasm 文件，包含编译后的字节码
- JavaScript 格式：.js 文件，包含源代码或打包后的代码
- 其他格式：根据 Provider 实现确定

**清单文件**
- 必需：bud.json，包含插件元数据和权限声明
- 位于插件包的根目录

**配置文件**
- 可选：config.json，包含插件运行时的配置参数
- 支持运行时动态更新

**资源文件**
- 可选：图标、本地化字符串、静态资源等
- 通过相对路径引用

### Manifest (清单)

bud.json 是插件的描述文件，采用 JSON 格式，包含以下顶级字段：

```json
{
  "id": "com.example.my-plugin",
  "name": "我的插件",
  "version": "1.0.0",
  "description": "这是一个示例插件",
  "author": "开发者 <developer@example.com>",
  "provider": "wasm",
  "main": "plugin.wasm",
  "permissions": [
    "call_api:system.getSystemInfo",
    "call_api:ui.renderWidget",
    "call_api:network.httpRequest"
  ],
  "compatible_version": ">=1.0.0",
  "keywords": ["utility", "productivity"],
  "license": "MIT"
}
```

**字段说明**

| 字段 | 必填 | 说明 |
|------|------|------|
| id | 是 | 插件唯一标识符，采用反向域名格式 |
| name | 是 | 插件显示名称 |
| version | 是 | 语义化版本号 |
| description | 否 | 插件功能描述 |
| author | 否 | 作者信息 |
| provider | 是 | 指定使用的 Provider 类型 |
| main | 是 | 插件入口文件名 |
| permissions | 是 | 权限声明数组 |
| compatible_version | 否 | 兼容的 Runtime 版本范围 |
| keywords | 否 | 插件标签，用于搜索 |
| license | 否 | 开源许可证 |

### Provider (提供者)

Provider 是插件执行环境的抽象接口，负责插件的实际加载和执行。

**WASM Provider**

WASM Provider 使用 WebAssembly 运行时（如 Wasmer 或 Wasmtime）执行插件：

```rust
trait WasmProvider {
    fn load(&self, wasm_bytes: &[u8]) -> Result<WasmInstance, ProviderError>;
    fn register_function(&mut self, name: &str, func: HostFunction);
    fn execute(&self, instance: &WasmInstance, entrypoint: &str) -> Result<Value, RuntimeError>;
    fn set_memory_limit(&mut self, limit: usize);
    fn terminate(&mut self, instance: &WasmInstance);
}
```

**Bun Provider**

Bun Provider 探索中，利用 Bun 运行时执行 JavaScript/TypeScript 插件：

- 支持原生 ESM 模块
- 利用 Bun 的快速启动特性
- 集成 TypeScript 编译支持

**Provider 接口规范**

所有 Provider 必须实现以下接口方法：

| 方法 | 职责 |
|------|------|
| load() | 加载插件包，验证格式 |
| instantiate() | 创建插件实例 |
| register_host_function() | 注册宿主函数供插件调用 |
| execute() | 执行插件入口函数 |
| terminate() | 终止插件实例，释放资源 |
| get_memory_usage() | 获取当前内存占用 |
| set_resource_limit() | 设置资源配额限制 |

### Permission (权限)

权限是插件访问宿主 API 的授权凭证，采用命名空间冒号格式。

**权限格式**

```
namespace:resource.action
```

- **命名空间 (namespace)**: API 分类，如 system、ui、network、storage
- **资源 (resource)**: 具体的功能模块，如 getSystemInfo、renderWidget
- **动作 (action)**: 操作类型，optional（默认所有操作）

**权限示例**

| 权限字符串 | 含义 |
|-----------|------|
| call_api:system.getSystemInfo | 调用系统信息获取 API |
| call_api:ui.renderWidget | 调用 UI 组件渲染 API |
| call_api:network.httpRequest | 发起 HTTP 网络请求 |
| call_api:storage.read | 读取存储数据 |
| call_api:storage.write | 写入存储数据 |

**权限级别**

- **普通权限**: 只需用户确认一次
- **敏感权限**: 每次使用需重新确认
- **危险权限**: 需要用户明确授权，可能造成安全风险

### Security Sandbox (安全沙箱)

安全沙箱通过多层防护机制确保插件运行的安全可控。

**代码隔离**

- 插件代码在独立的执行上下文中运行
- 内存空间与宿主应用隔离
- 禁止直接访问宿主进程的内存
- 禁止访问系统级资源（文件系统、进程列表等）

**权限隔离**

- 运行时权限检查：每次 API 调用前验证权限
- 参数验证：检查参数类型和范围
- 返回值过滤：防止信息泄露
- 调用频率限制：防止资源滥用

**资源隔离**

- 内存配额：限制插件可用内存上限
- CPU 时间片：防止无限循环占用资源
- 网络带宽：限制网络请求频率
- 存储配额：限制本地数据存储量

**沙箱逃逸防护**

- 定期安全审计
- 运行时行为监控
- 异常行为检测
- 紧急终止机制

## 设计哲学

### 开放与警惕 (Open by Default, Vigilant by Design)

Bud 的核心设计理念是"默认开放，警惕防御"：

**开放原则**

- **低门槛**: 任何格式正确的插件包都可以被加载
- **多样性**: 支持多种插件格式和 Provider
- **兼容性**: 向后兼容，支持插件版本演进
- **可扩展**: 开放的 API 设计，支持自定义扩展

**警惕原则**

- **显式声明**: 插件必须明确声明所需权限
- **用户授权**: 用户必须明确同意权限授予
- **最小权限**: 插件只应获得完成功能所需的最小权限
- **运行时检测**: 运行时持续监控插件行为

**安全与开放的平衡**

| 场景 | 处理方式 |
|------|----------|
| 格式正确但权限未知 | 提示用户确认 |
| 权限过高 | 警告用户风险 |
| 敏感操作 | 每次使用时再次确认 |
| 恶意行为 | 自动拦截并终止 |

### Provider 中立

Bud 采用 Provider 中立架构，不绑定特定运行时：

**架构优势**

- **运行时无关**: 不依赖特定的 WebAssembly 运行时
- **灵活选择**: 宿主应用可选择适合的 Provider
- **平滑演进**: 新运行时出现时可轻松集成
- **生态兼容**: 兼容多种插件生态

**Provider 抽象层**

```rust
trait PluginProvider: Send + Sync {
    type Instance: PluginInstance;

    fn name(&self) -> &'static str;
    fn version(&self) -> &'static str;

    async fn load(&self, package: &PluginPackage) -> Result<Self::Instance, LoadError>;
    async fn unload(&self, instance: &mut Self::Instance);
    async fn call(&self, instance: &Self::Instance, func: &str, args: &[Value]) -> Result<Value, CallError>;
}
```

**多 Provider 协作**

- 单个宿主应用可同时加载多个 Provider
- 插件根据声明选择对应的 Provider
- Runtime 协调跨 Provider 的插件通信

## 关键流程

### 插件加载流程

插件加载是一个多阶段的过程，涉及验证、授权和实例化：

```
┌────────────────────────────────────────────────────────────────┐
│  阶段 1: 接收请求                                               │
│  ─────────────────────────────────────────────────────────────│
│  用户/应用发起加载请求                                          │
│  输入: 插件包路径或 URL                                         │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 2: 包结构验证                                             │
│  ─────────────────────────────────────────────────────────────│
│  1. 检查文件是否存在                                            │
│  2. 验证压缩包格式（ZIP/TAR）                                   │
│  3. 提取文件列表                                                │
│  4. 验证必需文件存在（bud.json, main）                          │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 3: 清单解析                                               │
│  ─────────────────────────────────────────────────────────────│
│  1. 读取并解析 bud.json                                         │
│  2. 验证必需字段存在                                            │
│  3. 验证版本格式正确                                            │
│  4. 验证权限声明格式正确                                        │
│  输出: ParsedManifest 结构体                                    │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 4: 权限提取                                               │
│  ─────────────────────────────────────────────────────────────│
│  1. 提取 permissions 数组                                       │
│  2. 解析权限字符串为结构化 Permission 对象                       │
│  3. 构建权限依赖树                                              │
│  4. 标记权限级别（普通/敏感/危险）                               │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 5: 权限展示                                               │
│  ─────────────────────────────────────────────────────────────│ │
│  1. 构建权限描述文案                                            │
│  2. 按风险级别分组                                              │
│  3. 生成用户友好的展示界面                                      │
│  4. 显示插件信息和权限列表                                      │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 6: 用户授权                                               │
│  ─────────────────────────────────────────────────────────────│
│  1. 等待用户操作（允许/拒绝/仅一次）                             │
│  2. 记录用户决策                                                │
│  3. 对于危险权限，可能需要额外验证                               │
└──────────────────────────┬─────────────────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
    ┌─────────────────┐       ┌─────────────────┐
    │  用户拒绝        │       │  用户允许        │
    │  → 加载失败      │       │  → 继续实例化    │
    └─────────────────┘       └────────┬────────┘
                                       │
                                       ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 7: Provider 实例化                                        │
│  ─────────────────────────────────────────────────────────────│
│  1. 选择对应的 Provider                                         │
│  2. 加载插件主文件                                              │
│  3. 实例化插件运行环境                                          │
│  4. 配置资源配额                                                │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 8: 宿主函数注入                                           │
│  ─────────────────────────────────────────────────────────────│
│  1. 注入已授权的宿主函数到插件作用域                             │
│  2. 建立函数调用桥接                                            │
│  3. 设置权限检查拦截器                                          │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│  阶段 9: 插件就绪                                               │
│  ─────────────────────────────────────────────────────────────│
│  1. 调用插件初始化入口                                          │
│  2. 注册事件处理函数                                            │
│  3. 进入事件循环                                                │
│  状态: PluginState::Ready                                       │
└────────────────────────────────────────────────────────────────┘
```

### 插件执行流程

插件加载完成后，进入正常运行阶段：

```
┌─────────────────────────────────────────────────────────────────┐
│  初始化阶段                                                     │
│  ──────────────────────────────────────────────────────────────│
│  1. 调用插件的 _init() 入口函数                                  │
│  2. 传递初始化配置参数                                           │
│  3. 插件返回初始化结果                                           │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  事件订阅阶段                                                   │
│  ──────────────────────────────────────────────────────────────│
│  1. 插件调用 register_handler() 注册事件处理器                   │
│  2. Runtime 记录事件与处理器的映射                               │
│  3. 支持多事件监听                                               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  等待阶段                                                       │
│  ──────────────────────────────────────────────────────────────│
│  插件进入空闲状态                                                │
│  等待事件触发                                                    │
│  期间可以:                                                      │
│  - 响应定时器事件                                               │
│  - 响应用户交互事件                                             │
│  - 响应系统事件                                                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  事件触发                                                       │
│  ──────────────────────────────────────────────────────────────│
│  1. 事件发生（用户点击、定时器、网络响应等）                      │
│  2. Runtime 查找对应的事件处理器                                 │
│  3. 准备事件参数                                                │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  函数调用阶段                                                   │
│  ──────────────────────────────────────────────────────────────│
│  1. 插件调用宿主函数（如 network.httpRequest）                   │
│  2. Runtime 检查权限授予状态                                     │
│  3. 验证参数合法性                                              │
│  4. 调用宿主函数实现                                            │
│  5. 返回结果或错误                                              │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  结果处理                                                       │
│  ──────────────────────────────────────────────────────────────│
│  1. 插件接收返回值                                              │
│  2. 处理错误情况                                                │
│  3. 继续执行业务逻辑                                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           │  返回等待阶段
                           └────────────────────────►
```

### 权限质询流程

权限质询是用户授权的核心流程：

```
┌─────────────────────────────────────────────────────────────────┐
│  步骤 1: 权限提取                                               │
│  ──────────────────────────────────────────────────────────────│
│  Runtime 从插件清单中提取权限列表                                │
│  构建 Permission 对象树                                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 2: 状态标记                                               │
│  ──────────────────────────────────────────────────────────────│
│  将插件状态设置为 PluginState::PendingAuthorization             │
│  阻止插件执行，直到获得授权                                      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 3: 返回主程序                                             │
│  ──────────────────────────────────────────────────────────────│
│  将权限列表和插件信息返回给宿主应用                              │
│  触发权限 UI 显示                                               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 4: UI 展示                                                │
│  ──────────────────────────────────────────────────────────────│
│  主程序显示权限确认对话框                                       │
│  内容包括:                                                      │
│  - 插件名称和图标                                               │
│  - 权限列表及说明                                               │
│  - 风险等级提示                                                 │
│  - 授权选项（允许/拒绝/仅一次）                                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 5: 用户决策                                               │
│  ──────────────────────────────────────────────────────────────│
│  用户做出授权决策                                               │
│  选项:                                                          │
│  - 允许全部: 授予所有请求的权限                                  │
│  - 允许部分: 用户选择性地授予权限                                │
│  - 仅一次: 本次会话授予，下次需重新确认                          │
│  - 拒绝: 不授予任何权限                                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  拒绝       │ │  允许       │ │  仅一次     │
    │  → 卸载    │ │  → 激活    │ │  → 临时激活 │
    └─────────────┘ └─────────────┘ └─────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 6: 通知 Runtime                                           │
│  ──────────────────────────────────────────────────────────────│
│  主程序将用户决策通知 Runtime                                   │
│  Runtime 更新权限授予状态                                       │
│  根据决策结果激活或拒绝插件                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 事件系统流程

事件系统是插件与宿主应用通信的核心机制：

```
事件类型分类
──────────────────────────────────────────────────────────────

用户交互事件:
  - click: 鼠标点击
  - keypress: 键盘输入
  - scroll: 滚动
  - drag: 拖拽

系统事件:
  - startup: 应用启动
  - shutdown: 应用关闭
  - pause: 应用暂停
  - resume: 应用恢复

定时事件:
  - timer: 一次性定时器
  - interval: 周期定时器

网络事件:
  - http_response: HTTP 响应
  - websocket_message: WebSocket 消息

自定义事件:
  - app_specific: 应用特定事件
  - plugin_emit: 插件间通信事件


事件流
──────────────────────────────────────────────────────────────

事件源 ──► 事件总线 ──► 事件路由器 ──► 事件处理器
                         │
                         ├──► 过滤
                         ├──► 转换
                         └──► 路由到多个处理器

插件订阅事件
──────────────────────────────────────────────────────────────

插件代码:
  ```javascript
  bud.on('user.click', (event) => {
    // 处理点击事件
    console.log('Clicked at:', event.position);
  });

  bud.interval(1000, () => {
    // 每秒执行
    console.log('Tick');
  });
  ```

事件传递参数
──────────────────────────────────────────────────────────────

每个事件携带:
  - event.type: 事件类型
  - event.source: 事件来源
  - event.timestamp: 事件时间戳
  - event.data: 事件数据（类型特定）
  - event.target: 目标对象（如果适用）
```

## 附录

### 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 宿主应用 | Host Application | 使用 Bud Runtime 的主应用程序 |
| 运行时 | Runtime | Bud 的核心引擎，负责插件管理 |
| 插件 | Plugin | 功能扩展模块 |
| 清单 | Manifest | 插件描述文件（bud.json） |
| 提供者 | Provider | 插件执行环境抽象 |
| 权限 | Permission | API 访问授权凭证 |
| 沙箱 | Sandbox | 安全隔离环境 |
| 宿主函数 | Host Function | 宿主应用暴露给插件的 API |

### 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0.0 | 2026-01-25 | 初始文档版本 |
